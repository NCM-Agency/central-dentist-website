---
// BlurFade.astro - Scroll-triggered blur-fade animation component
export interface Props {
  delay?: number;
  duration?: number;
  offset?: number;
  direction?: 'up' | 'down' | 'left' | 'right';
  blur?: string;
  class?: string;
}

const { 
  delay = 0,
  duration = 400,
  offset = 6,
  direction = 'up',
  blur = '6px',
  class: className = ''
} = Astro.props;

// Generate unique ID for this component instance
const id = Math.random().toString(36).substr(2, 9);
---

<div 
  class={`blur-fade-element opacity-0 ${className}`}
  data-blur-fade-id={id}
  data-delay={delay}
  data-duration={duration}
  data-offset={offset}
  data-direction={direction}
  data-blur={blur}
  style={`
    filter: blur(${blur});
    transform: translate${direction === 'left' || direction === 'right' ? 'X' : 'Y'}(${
      direction === 'right' || direction === 'down' ? offset : -offset
    }px);
    transition: all ${duration}ms cubic-bezier(0.4, 0, 0.2, 1);
    transition-delay: ${delay}ms;
  `}
>
  <slot />
</div>

<script>
  // Intersection Observer for blur-fade animations
  function initBlurFadeAnimations() {
    const elements = document.querySelectorAll('.blur-fade-element');
    
    if (!elements.length) return;
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const element = entry.target as HTMLElement;
          const delay = parseInt(element.dataset.delay || '0');
          
          setTimeout(() => {
            element.style.opacity = '1';
            element.style.filter = 'blur(0px)';
            element.style.transform = 'translate(0, 0)';
          }, delay);
          
          observer.unobserve(element);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '-50px'
    });
    
    elements.forEach((element) => {
      observer.observe(element);
    });
  }

  // Multiple initialization strategies to ensure it works
  function tryInitialize() {
    initBlurFadeAnimations();
  }
  
  // Try immediate initialization
  tryInitialize();
  
  // Try on DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryInitialize);
  }
  
  // Try after a short delay to ensure Astro has finished rendering
  setTimeout(tryInitialize, 100);
  
  // Re-initialize on Astro navigation
  document.addEventListener('astro:page-load', tryInitialize);
  
  // Also try on window load as a fallback
  window.addEventListener('load', tryInitialize);
</script>

<style>
  /* Accessibility: Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .blur-fade-element {
      opacity: 1 !important;
      filter: none !important;
      transform: none !important;
      transition: none !important;
    }
  }
</style>