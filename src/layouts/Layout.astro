---
// Layout.astro - Main site layout with SEO, meta tags, and GrapesJS preparation
import Header from '../components/common/Header.astro';
import Footer from '../components/common/Footer.astro';
import ContactWidget from '../components/ContactWidget.astro';
import '../styles/global.css';

export interface Props {
  title: string;
  description?: string;
  keywords?: string;
  ogImage?: string;
  canonicalURL?: string;
  noindex?: boolean;
  schemaType?: 'WebPage' | 'MedicalBusiness' | 'BlogPosting' | 'Service';
  currentPath?: string;
}

const { 
  title,
  description = "Holistic Family Dentistry practice in Dallas, TX focusing on preventive and biocompatible oral health therapy addressing the root causes of disease.",
  keywords = "holistic dentistry Dallas, mercury-free dentist, biocompatible dental materials, ceramic implants, ozone therapy, sleep breathing disorder, TMJ treatment",
  ogImage = "/images/LOGO-01.png",
  canonicalURL,
  noindex = false,
  schemaType = 'WebPage',
  currentPath = Astro.url.pathname
} = Astro.props;

// Construct full title
const fullTitle = title === 'Home' ? 'Central Dentist | Holistic Family Dentistry | Dallas, TX' : `${title} | Central Dentist`;

// Business information for schema
const businessInfo = {
  name: 'Central Dentist',
  description: 'Holistic Family Dentistry practice in Dallas, TX',
  url: 'https://www.centraldentist.com',
  phone: '214-368-0900',
  email: 'info@centraldentist.com',
  address: {
    streetAddress: '10210 N Central Expy, Ste 100',
    addressLocality: 'Dallas',
    addressRegion: 'TX',
    postalCode: '75231',
    addressCountry: 'US'
  },
  openingHours: [
    'Mo-Th 08:00-17:00',
    'Fr 08:00-14:00'
  ]
};

// Generate schema markup based on page type
const generateSchemaMarkup = (type: string) => {
  const baseSchema = {
    '@context': 'https://schema.org',
    '@type': type === 'MedicalBusiness' ? 'Dentist' : type,
    name: businessInfo.name,
    description: businessInfo.description,
    url: canonicalURL || businessInfo.url
  };

  if (type === 'MedicalBusiness' || type === 'Dentist') {
    return {
      ...baseSchema,
      '@type': 'Dentist',
      telephone: businessInfo.phone,
      email: businessInfo.email,
      address: {
        '@type': 'PostalAddress',
        ...businessInfo.address
      },
      openingHoursSpecification: businessInfo.openingHours.map(hours => ({
        '@type': 'OpeningHoursSpecification',
        dayOfWeek: hours.substring(0, 2) === 'Mo' ? ['Monday', 'Tuesday', 'Wednesday', 'Thursday'] : ['Friday'],
        opens: hours.substring(3, 8),
        closes: hours.substring(9, 14)
      })),
      priceRange: '$$$',
      paymentAccepted: 'Cash, Credit Card, Insurance',
      areaServed: 'Dallas, TX',
      medicalSpecialty: 'Holistic Dentistry'
    };
  }

  return baseSchema;
};

const schemaMarkup = generateSchemaMarkup(schemaType);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <meta name="format-detection" content="telephone=no" />
    
    <!-- SEO Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    {canonicalURL && <link rel="canonical" href={canonicalURL} />}
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={canonicalURL || businessInfo.url} />
    <meta property="og:site_name" content="Central Dentist" />
    
    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json" set:html={JSON.stringify(schemaMarkup)} />
    
    <!-- Performance and Accessibility -->
    <meta name="theme-color" content="#006786" />
    <meta name="msapplication-TileColor" content="#006786" />
    
    <!-- GrapesJS Preparation Attributes -->
    <meta name="gjs-project-id" content="central-dentist" />
    <meta name="gjs-editable" content="true" />
    
    <!-- Lottie Player for animations -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <!-- Netlify Identity Widget for CMS authentication -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>

  <body 
    class="font-body text-gray-dark antialiased"
    data-gjs-type="body"
  >
    <!-- Skip to main content link for accessibility -->
    <a 
      href="#main-content" 
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-teal text-white px-4 py-2 rounded-md z-50"
    >
      Skip to main content
    </a>

    <!-- Site Header -->
    <Header currentPath={currentPath} />

    <!-- Main Content -->
    <main 
      id="main-content"
      class="min-h-screen"
      data-gjs-type="main"
    >
      <slot />
    </main>

    <!-- Site Footer -->
    <Footer />

    <!-- Contact Widget (Netlify Forms) -->
    <ContactWidget />

    <!-- Back to Top Button -->
    <button 
      id="back-to-top"
      class="fixed bottom-20 right-6 bg-teal text-white p-3 rounded-full shadow-teal-lg opacity-0 invisible transition-all hover:bg-teal-dark hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-teal focus:ring-offset-2 z-30"
      aria-label="Back to top"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
      </svg>
    </button>

    <!-- Tawk.to Script (Disabled - Using Netlify Forms Widget Instead) -->
    <!-- To re-enable Tawk.to chat, uncomment the following:
    <script type="text/javascript">
      var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
      (function(){
        var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
        s1.async=true;
        s1.src='https://embed.tawk.to/690a655eb652a7194ed8bbb6/1j989nu5i';
        s1.charset='UTF-8';
        s1.setAttribute('crossorigin','*');
        s0.parentNode.insertBefore(s1,s0);
      })();
    </script>
    -->

    <!-- Scripts -->
    <script>
      // Back to top button functionality
      document.addEventListener('DOMContentLoaded', function() {
        const backToTopButton = document.getElementById('back-to-top');
        
        if (backToTopButton) {
          // Show/hide button based on scroll position
          window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
              backToTopButton.classList.remove('opacity-0', 'invisible');
              backToTopButton.classList.add('opacity-100', 'visible');
            } else {
              backToTopButton.classList.add('opacity-0', 'invisible');
              backToTopButton.classList.remove('opacity-100', 'visible');
            }
          });

          // Smooth scroll to top when clicked
          backToTopButton.addEventListener('click', function() {
            window.scrollTo({
              top: 0,
              behavior: 'smooth'
            });
          });
        }

        // Enhanced focus management for accessibility
        document.addEventListener('keydown', function(e) {
          // Escape key handling for mobile menu
          if (e.key === 'Escape') {
            const mobileMenu = document.querySelector('.mobile-menu');
            const mobileMenuButton = document.querySelector('.mobile-menu-button');
            const menuIcon = document.querySelector('.menu-icon');
            const closeIcon = document.querySelector('.close-icon');

            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
              mobileMenu.classList.add('hidden');
              menuIcon?.classList.remove('hidden');
              closeIcon?.classList.add('hidden');
              mobileMenuButton?.setAttribute('aria-expanded', 'false');
              mobileMenuButton?.focus();
            }
          }
        });

        // Lazy load images
        if ('IntersectionObserver' in window) {
          const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src || img.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
              }
            });
          });

          document.querySelectorAll('img[loading="lazy"]').forEach(img => {
            imageObserver.observe(img);
          });
        }
      });

      // Performance monitoring
      if ('PerformanceObserver' in window) {
        const observer = new PerformanceObserver((list) => {
          list.getEntries().forEach((entry) => {
            // Log Core Web Vitals if needed for debugging
            if (entry.entryType === 'navigation') {
              console.log('Page load time:', entry.loadEventEnd - entry.loadEventStart);
            }
          });
        });

        observer.observe({ type: 'navigation', buffered: true });
      }
    </script>

    <!-- Netlify Identity Widget redirect handling -->
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>

    <!-- Google Analytics or other tracking scripts would go here -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script> -->
  </body>
</html>